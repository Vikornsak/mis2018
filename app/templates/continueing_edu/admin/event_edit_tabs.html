{% extends 'continueing_edu/admin/base.html' %}
{% block content %}
<div class="container mt-6 mb-6">
  <h1 class="title is-3 mb-4">Edit Event: {{ event.title_en or 'Untitled' }}</h1>

  <div class="tabs is-boxed">
    <ul>
      <li class="{% if active_tab=='general' %}is-active{% endif %}"><a href="?tab=general">General Info</a></li>
      <li class="{% if active_tab=='speakers' %}is-active{% endif %}"><a href="?tab=speakers">Speakers</a></li>
      <li class="{% if active_tab=='agenda' %}is-active{% endif %}"><a href="?tab=agenda">Agenda</a></li>
      <li class="{% if active_tab=='materials' %}is-active{% endif %}"><a href="?tab=materials">Materials</a></li>
      <li class="{% if active_tab=='fees' %}is-active{% endif %}"><a href="?tab=fees">Registration Fees</a></li>
      <li class="{% if active_tab=='roles' %}is-active{% endif %}"><a href="?tab=roles">Staff Roles</a></li>
    </ul>
  </div>

  {# ---------------- General Info ---------------- #}
  {% if active_tab == 'general' %}
  <div class="box">
    <form method="post" enctype="multipart/form-data" action="{{ url_for('continuing_edu_admin.update_event_general', event_id=event.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Title (EN)</label>
            <div class="control"><input class="input" type="text" name="title_en" value="{{ event.title_en or '' }}"
                required></div>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Title (TH)</label>
            <div class="control"><input class="input" type="text" name="title_th" value="{{ event.title_th or '' }}">
            </div>
          </div>
        </div>
      </div>

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Description (EN)</label>
            <div class="control"><textarea class="textarea"
                name="description_en">{{ event.description_en or '' }}</textarea></div>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Description (TH)</label>
            <div class="control"><textarea class="textarea"
                name="description_th">{{ event.description_th or '' }}</textarea></div>
          </div>
        </div>
      </div>

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Location (EN)</label>
            <div class="control"><input class="input" type="text" name="location_en"
                value="{{ event.location_en or '' }}"></div>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Location (TH)</label>
            <div class="control"><input class="input" type="text" name="location_th"
                value="{{ event.location_th or '' }}"></div>
          </div>
        </div>
      </div>

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Duration (EN)</label>
            <div class="control"><input class="input" type="text" name="duration_en"
                value="{{ event.duration_en or '' }}"></div>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Duration (TH)</label>
            <div class="control"><input class="input" type="text" name="duration_th"
                value="{{ event.duration_th or '' }}"></div>
          </div>
        </div>
      </div>

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Format (EN)</label>
            <div class="control"><input class="input" type="text" name="format_en" value="{{ event.format_en or '' }}">
            </div>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Format (TH)</label>
            <div class="control"><input class="input" type="text" name="format_th" value="{{ event.format_th or '' }}">
            </div>
          </div>
        </div>
      </div>

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Poster Image</label>
            <div class="control">
              <div class="file has-name is-fullwidth">
                <label class="file-label">
                  <input class="file-input" type="file" name="poster_image_file" accept="image/*">
                  <span class="file-cta"><span class="file-icon">ðŸ“·</span><span class="file-label">Choose a fileâ€¦</span></span>
                  <span class="file-name is-size-7">Upload a new poster image</span>
                </label>
              </div>
            </div>
            <p class="help">Or paste URL:</p>
            <div class="control"><input class="input" type="url" name="poster_image_url" placeholder="https://..."
                value="{{ event.poster_image_url or '' }}"></div>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Cover Image</label>
            <div class="control">
              <div class="file has-name is-fullwidth">
                <label class="file-label">
                  <input class="file-input" type="file" name="cover_image_file" accept="image/*">
                  <span class="file-cta"><span class="file-icon">ðŸ“·</span><span class="file-label">Choose a fileâ€¦</span></span>
                  <span class="file-name is-size-7">Upload a new cover image</span>
                </label>
              </div>
            </div>
            <p class="help">Or paste URL:</p>
            <div class="control"><input class="input" type="url" name="cover_image_url" placeholder="https://..."
                value="{{ event.cover_image_url or '' }}"></div>
          </div>
        </div>
      </div>

      {% if event.poster_image_url or event.cover_image_url %}
      <div class="columns">
        <div class="column">
          {% if event.poster_image_url %}
          <p class="label">Poster Preview</p>
          <figure class="image is-3by2" style="max-width: 320px;">
            {% set poster = (event.poster_presigned_url() or event.poster_image_url) %}
            <img src="{{ poster or '' }}" alt="Poster preview"
              style="object-fit:cover;border:1px solid #eee;">
          </figure>
          {% endif %}
        </div>
        <div class="column">
          {% if event.cover_image_url %}
          <p class="label">Cover Preview</p>
          <figure class="image is-3by2" style="max-width: 480px;">
            {% set cover = (event.cover_presigned_url() or event.cover_image_url) %}
            <img src="{{ cover or '' }}" alt="Cover preview" style="object-fit:cover;border:1px solid #eee;">
          </figure>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Certificate Name (EN)</label>
            <div class="control"><input class="input" type="text" name="certificate_name_en"
                value="{{ event.certificate_name_en or '' }}"></div>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Certificate Name (TH)</label>
            <div class="control"><input class="input" type="text" name="certificate_name_th"
                value="{{ event.certificate_name_th or '' }}"></div>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label">CE Score</label>
        <div class="control"><input class="input" type="number" step="0.01" name="continue_education_score"
            value="{{ event.continue_education_score or 0 }}"></div>
      </div>

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Early Bird Start</label>
            <div class="control">
              <input class="input" type="datetime-local" name="early_bird_start"
                value="{{ event.early_bird_start.strftime('%Y-%m-%dT%H:%M') if event.early_bird_start else '' }}">
            </div>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Early Bird End</label>
            <div class="control">
              <input class="input" type="datetime-local" name="early_bird_end"
                value="{{ event.early_bird_end.strftime('%Y-%m-%dT%H:%M') if event.early_bird_end else '' }}">
            </div>
          </div>
        </div>
      </div>

      <div class="field is-grouped">
        <div class="control"><button class="button is-primary" type="submit">Save General Info</button></div>
        <div class="control"><a class="button" href="{{ url_for('continuing_edu_admin.manage_events') }}">Back</a></div>
      </div>
    </form>
  </div>
  {% endif %}

  {# ---------------- Speakers ---------------- #}
  {% if active_tab == 'speakers' %}
  <div class="box">
    {% if speakers_pool and speakers_pool|length > 0 %}
    <h2 class="title is-5">Select Existing Speaker</h2>
    <form method="post" action="{{ url_for('continuing_edu_admin.attach_existing_speaker', event_id=event.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="columns">
        <div class="column is-two-thirds">
          <div class="select is-fullwidth">
            <select name="speaker_id" required>
              <option value="" disabled selected>Select a speakerâ€¦</option>
              {% for sp in speakers_pool %}
              <option value="{{ sp.id }}">{{ sp.name_en }} â€” {{ sp.institution_en }} ({{ sp.email }})</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="column">
          <button class="button is-link" type="submit">Add to Event</button>
        </div>
      </div>
    </form>
    <hr>
    {% endif %}

    <h2 class="title is-5">Add New Speaker</h2>
    <form method="post" action="{{ url_for('continuing_edu_admin.add_event_speaker', event_id=event.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="columns">
        <div class="column">
          <label class="label">Title (EN)</label>
          <input class="input" name="title_en" required>
        </div>
        <div class="column">
          <label class="label">Title (TH)</label>
          <input class="input" name="title_th" required>
        </div>
      </div>
      <div class="columns">
        <div class="column">
          <label class="label">Name (EN)</label>
          <input class="input" name="name_en" required>
        </div>
        <div class="column">
          <label class="label">Name (TH)</label>
          <input class="input" name="name_th" required>
        </div>
      </div>
      <div class="columns">
        <div class="column">
          <label class="label">Email</label>
          <input class="input" name="email" type="email" required>
        </div>
        <div class="column">
          <label class="label">Phone</label>
          <input class="input" name="phone" required>
        </div>
      </div>
      <div class="columns">
        <div class="column">
          <label class="label">Position (EN)</label>
          <input class="input" name="position_en">
        </div>
        <div class="column">
          <label class="label">Position (TH)</label>
          <input class="input" name="position_th">
        </div>
      </div>
      <div class="columns">
        <div class="column">
          <label class="label">Institution (EN)</label>
          <input class="input" name="institution_en" required>
        </div>
        <div class="column">
          <label class="label">Institution (TH)</label>
          <input class="input" name="institution_th" required>
        </div>
      </div>
      <div class="field">
        <label class="label">Image URL</label>
        <input class="input" name="image_url" placeholder="https://...">
      </div>
      <div class="columns">
        <div class="column">
          <label class="label">Bio (EN)</label>
          <textarea class="textarea" name="bio_en"></textarea>
        </div>
        <div class="column">
          <label class="label">Bio (TH)</label>
          <textarea class="textarea" name="bio_th"></textarea>
        </div>
      </div>
      <div class="field"><button class="button is-primary" type="submit">Add Speaker</button></div>
    </form>

    <hr>
    <h2 class="title is-5">Speakers</h2>
    {% if speakers %}
    {% for s in speakers %}
    <div class="box">
      <form method="post"
        action="{{ url_for('continuing_edu_admin.update_event_speaker', event_id=event.id, speaker_id=s.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <p class="mb-2"><strong>{{ s.name_en }}</strong> ({{ s.institution_en }})</p>
        <div class="columns">
          <div class="column"><input class="input" name="name_en" value="{{ s.name_en }}"></div>
          <div class="column"><input class="input" name="name_th" value="{{ s.name_th }}"></div>
        </div>
        <div class="columns">
          <div class="column"><input class="input" name="email" value="{{ s.email }}"></div>
          <div class="column"><input class="input" name="phone" value="{{ s.phone }}"></div>
        </div>
        <div class="field is-grouped">
          <div class="control"><button class="button is-link" type="submit">Save</button></div>
          <div class="control">
            <button class="button is-danger" type="submit" formmethod="post"
              formaction="{{ url_for('continuing_edu_admin.delete_event_speaker', event_id=event.id, speaker_id=s.id) }}">Delete</button>
          </div>
        </div>
      </form>
    </div>
    {% endfor %}
    {% else %}
    <p>No speakers yet.</p>
    {% endif %}
  </div>
  {% endif %}

  {# ---------------- Agenda ---------------- #}
  {% if active_tab == 'agenda' %}
  <div class="box">
    <h2 class="title is-5">Add Agenda Item</h2>
    <form method="post" action="{{ url_for('continuing_edu_admin.add_event_agenda', event_id=event.id) }}"
      hx-post="{{ url_for('continuing_edu_admin.add_event_agenda', event_id=event.id) }}" hx-target="#agenda-list"
      hx-swap="outerHTML">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="columns">
        <div class="column"><label class="label">Title (EN)</label><input class="input" name="title_en" required></div>
        <div class="column"><label class="label">Title (TH)</label><input class="input" name="title_th" required></div>
      </div>
      <div class="columns">
        <div class="column"><label class="label">Start</label><input class="input" type="datetime-local"
            name="start_time" required></div>
        <div class="column"><label class="label">End</label><input class="input" type="datetime-local" name="end_time"
            required></div>
        <div class="column is-one-quarter"><label class="label">Order</label><input class="input" type="number"
            name="order" value="0"></div>
      </div>
      <div class="columns">
        <div class="column"><label class="label">Description (EN)</label><textarea class="textarea"
            name="description_en"></textarea></div>
        <div class="column"><label class="label">Description (TH)</label><textarea class="textarea"
            name="description_th"></textarea></div>
      </div>
      <button class="button is-primary" type="submit">Add Agenda</button>
    </form>

    <hr>
    <div hx-get="{{ url_for('continuing_edu_admin.agendas_partial', event_id=event.id) }}" hx-trigger="load"></div>
  </div>
  {% endif %}

  {# ---------------- Materials ---------------- #}
  {% if active_tab == 'materials' %}
  <div class="box">
    <h2 class="title is-5">Add Material</h2>
    <form method="post" action="{{ url_for('continuing_edu_admin.add_event_material', event_id=event.id) }}"
      hx-post="{{ url_for('continuing_edu_admin.add_event_material', event_id=event.id) }}" hx-target="#materials-list"
      hx-swap="outerHTML">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="columns">
        <div class="column is-one-quarter"><label class="label">Order</label><input class="input" type="number"
            name="order" value="0"></div>
        <div class="column"><label class="label">Title (EN)</label><input class="input" name="title_en" required></div>
        <div class="column"><label class="label">Title (TH)</label><input class="input" name="title_th" required></div>
      </div>
      <div class="columns">
        <div class="column"><label class="label">Description (EN)</label><textarea class="textarea"
            name="description_en"></textarea></div>
        <div class="column"><label class="label">Description (TH)</label><textarea class="textarea"
            name="description_th"></textarea></div>
      </div>
      <div class="field"><label class="label">Material URL</label><input class="input" name="material_url"
          placeholder="https://..." required></div>
      <button class="button is-primary" type="submit">Add Material</button>
    </form>

    <hr>
    <div hx-get="{{ url_for('continuing_edu_admin.materials_partial', event_id=event.id) }}" hx-trigger="load"></div>
  </div>
  {% endif %}

  {# ---------------- Fees ---------------- #}
  {% if active_tab == 'fees' %}
  <div class="box">
    <h2 class="title is-5">Add Registration Fee</h2>
    <form method="post" action="{{ url_for('continuing_edu_admin.add_event_fee', event_id=event.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="columns">
        <div class="column">
          <label class="label">Member Type</label>
          <div class="select is-fullwidth">
            <select name="member_type_id" required>
              <option value="" disabled selected>Select type</option>
              {% for mt in member_types %}
              <option value="{{ mt.id }}">{{ mt.name_en }} / {{ mt.name_th }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="column">
          <label class="label">Price</label>
          <input class="input" type="number" step="0.01" name="price" required>
        </div>
        <div class="column">
          <label class="label">Early Bird Price</label>
          <input class="input" type="number" step="0.01" name="early_bird_price" placeholder="Optional">
        </div>
      </div>
      <button class="button is-primary" type="submit">Add Fee</button>
    </form>

    <hr>
    <h2 class="title is-5">Fees</h2>
    {% if fees %}
    {% for f in fees %}
    <div class="box">
      <form method="post"
        action="{{ url_for('continuing_edu_admin.update_event_fee', event_id=event.id, fee_id=f.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="columns">
          <div class="column">
            <div class="select is-fullwidth">
              <select name="member_type_id">
                {% for mt in member_types %}
                <option value="{{ mt.id }}" {% if f.member_type_id==mt.id %}selected{% endif %}>{{ mt.name_en }} / {{
                  mt.name_th }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="column">
            <input class="input" type="number" step="0.01" name="price" value="{{ '%.2f'|format(f.price) }}">
          </div>
          <div class="column">
            <input class="input" type="number" step="0.01" name="early_bird_price"
              value="{{ '%.2f'|format(f.early_bird_price) if f.early_bird_price is not none else '' }}"
              placeholder="Early Bird Price">
          </div>
        </div>
        <div class="field is-grouped">
          <div class="control"><button class="button is-link" type="submit">Save</button></div>
          <div class="control">
            <button class="button is-danger" type="submit" formmethod="post"
              formaction="{{ url_for('continuing_edu_admin.delete_event_fee', event_id=event.id, fee_id=f.id) }}">Delete</button>
          </div>
        </div>
      </form>
    </div>
    {% endfor %}
    {% else %}
    <p>No fees yet.</p>
    {% endif %}
  </div>
  {% endif %}

  {# ---------------- Staff Roles ---------------- #}
  {% if active_tab == 'roles' %}
  <div class="box">
    <h2 class="title is-5">Assign Staff Role</h2>
    <form method="post" action="{{ url_for('continuing_edu_admin.update_event_roles', event_id=event.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="columns">
        <div class="column is-one-quarter">
          <label class="label">Role</label>
          <div class="select is-fullwidth">
            <select name="role_type" required>
              <option value="" disabled selected>Select role</option>
              <option value="editor">Editor</option>
              <option value="registration_reviewer">Registration Reviewer</option>
              <option value="payment_approver">Payment Approver</option>
              <option value="receipt_issuer">Receipt Issuer</option>
              <option value="certificate_manager">Certificate Manager</option>
            </select>
          </div>
        </div>
        <div class="column">
          <label class="label">Staff</label>
          <div class="select is-fullwidth">
            <select name="staff_id" required>
              <option value="" disabled selected>Select staff</option>
              {% for st in staff_list %}
              <option value="{{ st.id }}">{{ st.personal_info.fullname }} ({{ st.email }})</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <button class="button is-primary" type="submit">Assign</button>
    </form>

    <hr>
    <h2 class="title is-5">Current Assignments</h2>
    <div class="columns">
      <div class="column">
        <h3 class="title is-6">Editors</h3>
        {% for r in editors %}
        <form method="post" action="{{ url_for('continuing_edu_admin.update_event_roles', event_id=event.id) }}"
          class="mb-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="remove_role_{{ r.id }}" value="editor:{{ r.id }}">
          <span>{{ r.staff.personal_info.fullname }}</span>
          <button class="button is-small is-light is-danger" type="submit">Remove</button>
        </form>
        {% else %}<p class="is-size-7">None</p>{% endfor %}
      </div>
      <div class="column">
        <h3 class="title is-6">Registration Reviewers</h3>
        {% for r in registration_reviewers %}
        <form method="post" action="{{ url_for('continuing_edu_admin.update_event_roles', event_id=event.id) }}"
          class="mb-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="remove_role_{{ r.id }}" value="registration_reviewer:{{ r.id }}">
          <span>{{ r.staff.personal_info.fullname }}</span>
          <button class="button is-small is-light is-danger" type="submit">Remove</button>
        </form>
        {% else %}<p class="is-size-7">None</p>{% endfor %}
      </div>
      <div class="column">
        <h3 class="title is-6">Payment Approvers</h3>
        {% for r in payment_approvers %}
        <form method="post" action="{{ url_for('continuing_edu_admin.update_event_roles', event_id=event.id) }}"
          class="mb-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="remove_role_{{ r.id }}" value="payment_approver:{{ r.id }}">
          <span>{{ r.staff.personal_info.fullname }}</span>
          <button class="button is-small is-light is-danger" type="submit">Remove</button>
        </form>
        {% else %}<p class="is-size-7">None</p>{% endfor %}
      </div>
      <div class="column">
        <h3 class="title is-6">Receipt Issuers</h3>
        {% for r in receipt_issuers %}
        <form method="post" action="{{ url_for('continuing_edu_admin.update_event_roles', event_id=event.id) }}"
          class="mb-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="remove_role_{{ r.id }}" value="receipt_issuer:{{ r.id }}">
          <span>{{ r.staff.personal_info.fullname }}</span>
          <button class="button is-small is-light is-danger" type="submit">Remove</button>
        </form>
        {% else %}<p class="is-size-7">None</p>{% endfor %}
      </div>
      <div class="column">
        <h3 class="title is-6">Certificate Managers</h3>
        {% for r in certificate_managers %}
        <form method="post" action="{{ url_for('continuing_edu_admin.update_event_roles', event_id=event.id) }}"
          class="mb-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <input type="hidden" name="remove_role_{{ r.id }}" value="certificate_manager:{{ r.id }}">
          <span>{{ r.staff.personal_info.fullname }}</span>
          <button class="button is-small is-light is-danger" type="submit">Remove</button>
        </form>
        {% else %}<p class="is-size-7">None</p>{% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}
{% block scripts %}
<script>
  function initSortables() {
    if (!window.Sortable) return;
    var agendaItems = document.getElementById('agenda-items');
    if (agendaItems && !agendaItems.__sortableBound) {
      new Sortable(agendaItems, {
        handle: '.box',
        animation: 150,
        onEnd: function () {
          var ids = Array.from(agendaItems.querySelectorAll('.agenda-item'))
            .map(function (el) { return el.getAttribute('data-id'); });
          if (window.htmx) {
            htmx.ajax('POST', '{{ url_for('continuing_edu_admin.reorder_agendas', event_id=event.id) }}', {
              values: { 'order[]': ids },
              target: '#agenda-list',
              swap: 'outerHTML'
            });
          }
        }
      });
      agendaItems.__sortableBound = true;
    }

    var materialItems = document.getElementById('materials-items');
    if (materialItems && !materialItems.__sortableBound) {
      new Sortable(materialItems, {
        handle: '.box',
        animation: 150,
        onEnd: function () {
          var ids = Array.from(materialItems.querySelectorAll('.materials-item'))
            .map(function (el) { return el.getAttribute('data-id'); });
          if (window.htmx) {
            htmx.ajax('POST', '{{ url_for('continuing_edu_admin.reorder_materials', event_id=event.id) }}', {
              values: { 'order[]': ids },
              target: '#materials-list',
              swap: 'outerHTML'
            });
          }
        }
      });
      materialItems.__sortableBound = true;
    }
  }
  // Initial bind
  initSortables();
  // Re-bind after HTMX swaps on lists
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    var t = evt.target;
    if (t && (t.id === 'agenda-list' || t.id === 'materials-list')) {
      initSortables();
    }
  });
</script>
{% endblock %}
